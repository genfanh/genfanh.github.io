<!DOCTYPE html>
<html lang="zh-CN">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='å¯¹k8s client-go Informeræœºåˆ¶çš„å­¦ä¹ æ€»ç»“'><title>client-go Informerç®€ä»‹</title>

<link rel='canonical' href='https://genfanh.github.io/p/client-go-informer/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='client-go Informerç®€ä»‹'>
<meta property='og:description' content='å¯¹k8s client-go Informeræœºåˆ¶çš„å­¦ä¹ æ€»ç»“'>
<meta property='og:url' content='https://genfanh.github.io/p/client-go-informer/'>
<meta property='og:site_name' content='genfanh Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='k8s' /><meta property='article:tag' content='client-go' /><meta property='article:published_time' content='2021-02-03T20:38:01&#43;08:00'/><meta property='article:modified_time' content='2021-02-03T20:38:01&#43;08:00'/>
<meta name="twitter:title" content="client-go Informerç®€ä»‹">
<meta name="twitter:description" content="å¯¹k8s client-go Informeræœºåˆ¶çš„å­¦ä¹ æ€»ç»“"><link rel="shortcut icon" href="/img/favicon.ico">
<link rel="icon" href="/img/favicon.ico"> 
    </head>
    <body class="">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.body.dataset.scheme = 'dark';
        } else {
            document.body.dataset.scheme = 'light';
        }
    })();
</script><div class="container main-container flex on-phone--column extended article-page with-toolbar">
            <aside class="sidebar left-sidebar sticky">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header class="site-info">
        
            <figure class="site-avatar">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hua56bc347e42857790e9beb35033694f6_58905_300x0_resize_box_2.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                

                
                    <span class="emoji">ğŸ‰</span>
                
            </figure>
        
        <h1 class="site-name"><a href="https://genfanh.github.io">genfanh Blog</a></h1>
        <h2 class="site-description">æš‚æ—¶æ²¡æƒ³å¥½å¡«å•¥.</h2>
    </header>

    <ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/about'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        
            <li id="dark-mode-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                <span>æš—è‰²æ¨¡å¼</span>
            </li>
        
    </ol>
</aside>

            <main class="main full-width">
    <div id="article-toolbar">
        <a href="https://genfanh.github.io" class="back-home">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



            <span>Back</span>
        </a>
    </div>

    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/k8s/" >
                k8s
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/p/client-go-informer/">client-go Informerç®€ä»‹</a>
    </h2>

    
    <h3 class="article-subtitle">
        å¯¹k8s client-go Informeræœºåˆ¶çš„å­¦ä¹ æ€»ç»“
    </h3>
    <footer class="article-time">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <time class="article-time--published">Feb 03, 2021</time>
    </footer></div>
</header>

    <section class="article-content">
    <h2 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h2>
<p>k8så…¶ä»–ç»„ä»¶å¦‚kubeletã€controller managerã€scheduleréƒ½æ˜¯é€šè¿‡client-goçš„Informeræœºåˆ¶ä¸api-serverè¿›è¡Œé€šä¿¡ã€‚æ‰€ä»¥åœ¨é˜…è¯»ç»„ä»¶æºä»£ç æ—¶ï¼Œéœ€è¦å…ˆç†è§£client-goçš„informeræœºåˆ¶ã€‚</p>
<h2 id="2-informeræ¶æ„">2. Informeræ¶æ„</h2>
<p><figure style="flex-grow: 111; flex-basis: 266px">
		<a href="/p/client-go-informer/client-go-informer.png" data-size="712x641"><img src="/p/client-go-informer/client-go-informer.png"
				srcset="/p/client-go-informer/client-go-informer_hu37d4f752f33f54c3f89ae250191036e7_39009_480x0_resize_box_2.png 480w, /p/client-go-informer/client-go-informer_hu37d4f752f33f54c3f89ae250191036e7_39009_1024x0_resize_box_2.png 1024w"
				width="712"
				height="641"
				loading="lazy"
				alt="å›¾1 Infomeræ¶æ„">
		</a>
		
		<figcaption>å›¾1 Infomeræ¶æ„</figcaption>
		
	</figure></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼ŒInformerçš„ä¸­æ ¸å¿ƒç»„ä»¶æœ‰Reflectorã€DeltaFIFOä»¥åŠIndexerã€‚ä¸‹é¢å¯¹å„ä¸ªç»„ä»¶è¿›è¡Œé‡ç‚¹ä»‹ç»ï¼š</p>
<h3 id="21-reflector">2.1. Reflector</h3>
<p>Reflectorä¸»è¦ç”¨ä½œç›‘æ§(Watch)Informeråˆ›å»ºæ—¶æŒ‡å®šçš„k8sèµ„æºï¼ˆå¯ä»¥æ˜¯å†…ç½®èµ„æºæˆ–è€…CRDèµ„æºï¼‰ï¼Œå½“ç›‘æ§çš„<strong>èµ„æºå‘ç”Ÿå˜åŒ–</strong>æ—¶ä¼šè§¦å‘ç›¸åº”çš„äº‹ä»¶ï¼Œå¦‚Addedäº‹ä»¶ã€Updatedäº‹ä»¶ã€Deletedäº‹ä»¶ï¼ˆåˆ†åˆ«å¯¹åº”èµ„æºå¯¹è±¡çš„æ·»åŠ ã€æ›´æ–°ä»¥åŠåˆ é™¤ï¼‰ï¼Œå¹¶å°†è¯¥äº‹ä»¶å¯¹åº”çš„<strong>èµ„æºå¯¹è±¡</strong>å­˜æ”¾åˆ°æœ¬åœ°ç¼“å­˜DeltaFIFOä¸­ã€‚
Reflectorå¯¹è±¡ä¸»è¦é€šè¿‡NewReflectorå‡½æ•°è¿›è¡Œå®ä¾‹åŒ–ï¼ŒæŸ¥çœ‹å‡½æ•°å…¥å‚å¯ä»¥çŸ¥é“ï¼Œåœ¨Reflectorå¯¹è±¡å®ä¾‹åŒ–çš„æ—¶å€™éœ€è¦ä¼ å…¥ä¸€ä¸ªListerWatcheræ•°æ®æ¥å£å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ‹¥æœ‰Listå’ŒWatchæ–¹æ³•ï¼Œç”¨äºè·å–å’Œç›‘æ§èµ„æºåˆ—è¡¨ã€‚Reflectorå¯¹è±¡é€šè¿‡Runå‡½æ•°é©±åŠ¨ç›‘æ§å¹¶å¤„ç†ç›‘æ§äº‹ä»¶ï¼Œåœ¨Runå‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒReflectorä¸»è¦é‡å¤è¿è¡ŒListAndWatchå‡½æ•°è·å–èµ„æºåˆ—è¡¨(List)å¹¶ç›‘æ§(Watch)èµ„æºã€‚</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/reflector.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewReflector</span><span class="p">(</span><span class="nx">lw</span> <span class="nx">ListerWatcher</span><span class="p">,</span> <span class="nx">expectedType</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">store</span> <span class="nx">Store</span><span class="p">,</span> <span class="nx">resyncPeriod</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="o">*</span><span class="nx">Reflector</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">NewNamedReflector</span><span class="p">(</span><span class="nx">naming</span><span class="p">.</span><span class="nf">GetNameFromCallsite</span><span class="p">(</span><span class="nx">internalPackages</span><span class="o">...</span><span class="p">),</span> <span class="nx">lw</span><span class="p">,</span> <span class="nx">expectedType</span><span class="p">,</span> <span class="nx">store</span><span class="p">,</span> <span class="nx">resyncPeriod</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Run repeatedly uses the reflector&#39;s ListAndWatch to fetch all the
</span><span class="c1">// objects and subsequent deltas.
</span><span class="c1">// Run will exit when stopCh is closed.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Reflector</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="nx">wait</span><span class="p">.</span><span class="nf">BackoffUntil</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">ListAndWatch</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">r</span><span class="p">.</span><span class="nf">watchErrorHandler</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">},</span> <span class="nx">r</span><span class="p">.</span><span class="nx">backoffManager</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></div><p>ListAndWatchå‡½æ•°å®ç°ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š1ã€è·å–èµ„æºåˆ—è¡¨æ•°æ®(List)ï¼›2ã€ç›‘æ§èµ„æºå¯¹è±¡(Watch)</p>
<h4 id="211-è·å–èµ„æºæ•°æ®list">2.1.1. è·å–èµ„æºæ•°æ®(List)</h4>
<p>ListAndWatch Listæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<figure style="flex-grow: 46; flex-basis: 111px">
		<a href="/p/client-go-informer/reflector-list.png" data-size="271x581"><img src="/p/client-go-informer/reflector-list.png"
				srcset="/p/client-go-informer/reflector-list_hu8e359de6cae8f5648e277d72434a5836_28966_480x0_resize_box_2.png 480w, /p/client-go-informer/reflector-list_hu8e359de6cae8f5648e277d72434a5836_28966_1024x0_resize_box_2.png 1024w"
				width="271"
				height="581"
				loading="lazy"
				alt="å›¾2 ListAndWatch Listæµç¨‹å›¾">
		</a>
		
		<figcaption>å›¾2 ListAndWatch Listæµç¨‹å›¾</figcaption>
		
	</figure></p>
<ol>
<li>pager.New ä¸»è¦æ ¹æ®ListerWatcherçš„Listå‡½æ•°ç”Ÿæˆ pager å¯¹è±¡ï¼Œè‹¥ListerWacherå¯¹è±¡æ”¯æŒï¼ŒPagerå¯¹è±¡åœ¨åç»­è°ƒç”¨Listå‡½æ•°æ—¶ï¼Œä¼šä½¿ç”¨Chunkæ–¹å¼åˆ†å—è¿›è¡Œè·å–èµ„æºåˆ—è¡¨ï¼Œåä¹‹è‹¥ListerWacherå¯¹è±¡ä¸æ”¯æŒåˆ™ä¼šåœ¨ä¸€æ¬¡http requestä¸­è·å–æ‰€æœ‰èµ„æºå¯¹è±¡ã€‚</li>
<li>pager.List ç”¨äºè·å–èµ„æºä¸‹æ‰€æœ‰å¯¹è±¡çš„æ•°æ®ï¼Œå¦‚Podå¯¹è±¡æ‰€æœ‰æ•°æ®ã€‚è·å–èµ„æºæ•°æ®æ˜¯æ ¹æ®optionsçš„ResourceVersionå‚æ•°æ§åˆ¶ï¼ŒResourceVersion=0è¡¨ç¤ºè·å–æ‰€æœ‰æ•°æ®ï¼›ResourceVersion!=0è¡¨ç¤ºæ ¹æ®èµ„æºç‰ˆæœ¬å·ç»§ç»­è·å–ï¼Œç±»ä¼¼äºæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ã€‚é€šè¿‡ResouceVersionä¿è¯æœ¬åœ°ç¼“å­˜ä¸­æ•°æ®æœ‰Etcdä¸­æ•°æ®ä¿æŒä¸€è‡´ã€‚</li>
<li>listMetaInterface.GetResourceVersion ç”¨äºè·å–èµ„æºç‰ˆæœ¬å·ï¼ŒResourceVersionï¼ˆèµ„æºç‰ˆæœ¬å·ï¼‰ååˆ†é‡è¦ï¼ŒWatchæ“ä½œå¯ä»¥æ ¹æ®ResourceVersionåˆ¤æ–­å½“å‰èµ„æºå¯¹è±¡æ˜¯å¦å‘ç”Ÿæ”¹å˜ã€‚</li>
<li>meta.ExtractListç”¨äºå°†èµ„æºå¯¹è±¡æ•°æ®è½¬æ¢ä¸ºèµ„æºå¯¹è±¡åˆ—è¡¨ï¼Œå³æŠŠruntime.Objectè½¬ä¸º[]runtime.Objectã€‚</li>
<li>r.syncWith å°†èµ„æºå¯¹è±¡åˆ—è¡¨ä¸­çš„èµ„æºå¯¹è±¡å’Œå¯¹åº”ç‰ˆæœ¬å·å­˜å‚¨è‡³DeltaFIFOä¸­ï¼ŒåŒæ—¶ä¼šæ›¿æ¢å·²ç»å­˜åœ¨çš„å¯¹è±¡ã€‚</li>
<li>r.setLastSyncResourceVersion ä¼šè®¾ç½®æœ€æ–°çš„èµ„æºç‰ˆæœ¬å·ã€‚</li>
</ol>
<p>ListAndWatch Listä»£ç ç¤ºä¾‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/reflector.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Reflector</span><span class="p">)</span> <span class="nf">ListAndWatch</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="kd">var</span> <span class="nx">resourceVersion</span> <span class="kt">string</span>
	<span class="nx">options</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span><span class="nx">ResourceVersion</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nf">relistResourceVersion</span><span class="p">()}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="o">...</span>
		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="o">...</span>
			<span class="nx">pager</span> <span class="o">:=</span> <span class="nx">pager</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">pager</span><span class="p">.</span><span class="nf">SimplePageFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">listerWatcher</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
			<span class="p">}))</span>
			<span class="o">...</span>
			<span class="nx">list</span><span class="p">,</span> <span class="nx">paginatedResult</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pager</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">options</span><span class="p">)</span>
			<span class="o">...</span>
		<span class="p">}()</span>

		<span class="o">...</span>
		<span class="nx">listMetaInterface</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">meta</span><span class="p">.</span><span class="nf">ListAccessor</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span>
		<span class="o">...</span>
		<span class="nx">resourceVersion</span> <span class="p">=</span> <span class="nx">listMetaInterface</span><span class="p">.</span><span class="nf">GetResourceVersion</span><span class="p">()</span>
		<span class="o">...</span>
		<span class="nx">items</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">meta</span><span class="p">.</span><span class="nf">ExtractList</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span>
		<span class="o">...</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">syncWith</span><span class="p">(</span><span class="nx">items</span><span class="p">,</span> <span class="nx">resourceVersion</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to sync list result: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="o">...</span>
		<span class="nx">r</span><span class="p">.</span><span class="nf">setLastSyncResourceVersion</span><span class="p">(</span><span class="nx">resourceVersion</span><span class="p">)</span>
		<span class="o">...</span>
	<span class="p">}();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
  <span class="o">...</span>
<span class="p">}</span>
</code></pre></div><h4 id="212-ç›‘æ§èµ„æºå¯¹è±¡watch">2.1.2. ç›‘æ§èµ„æºå¯¹è±¡(Watch)</h4>
<p>Watchï¼ˆç›‘æ§ï¼‰æ“ä½œé€šè¿‡HTTPåè®®ä¸API-Serverå»ºç«‹é•¿è¿æ¥ï¼Œæ¥æ”¶api-serverå‘æ¥çš„èµ„æºå˜æ›´æ—¶é—´ï¼Œå®ç°çš„æœºåˆ¶æ˜¯ä½¿ç”¨HTTPåè®®çš„åˆ†å—ä¼ è¾“ç¼–ç (Chunked Transfer Encoding)ã€‚
ListAndWatch Watchä»£ç ç¤ºä¾‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/reflector.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Reflector</span><span class="p">)</span> <span class="nf">ListAndWatch</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="o">...</span>
		<span class="nx">timeoutSeconds</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">minWatchTimeout</span><span class="p">.</span><span class="nf">Seconds</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Float64</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">))</span>
		<span class="nx">options</span> <span class="p">=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span>
			<span class="nx">ResourceVersion</span><span class="p">:</span> <span class="nx">resourceVersion</span><span class="p">,</span>
			<span class="nx">TimeoutSeconds</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">timeoutSeconds</span><span class="p">,</span>
			<span class="nx">AllowWatchBookmarks</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="p">}</span>
    <span class="o">...</span>
		<span class="nx">w</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">listerWatcher</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
		<span class="o">...</span>

		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">watchHandler</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">resourceVersion</span><span class="p">,</span> <span class="nx">resyncerrc</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="o">...</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>r.watchHandler ç”¨äºå¤„ç†èµ„æºå˜æ›´çš„äº‹ä»¶ã€‚å½“å‡ºå‘Addedäº‹ä»¶ã€Updatedäº‹ä»¶ã€Deletedäº‹ä»¶æ—¶ï¼Œå°†å¯¹åº”çš„èµ„æºå¯¹è±¡æ›´æ–°åˆ°æœ¬åœ°ç¼“å­˜DeltaFIFOä¸­å¹¶æ›´æ–°ResourceVersionç‰ˆæœ¬å·ã€‚
r.watchHandler ä»£ç ç¤ºä¾‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/reflector.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Reflector</span><span class="p">)</span> <span class="nf">watchHandler</span><span class="p">(</span><span class="nx">start</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">w</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">resourceVersion</span> <span class="o">*</span><span class="kt">string</span><span class="p">,</span> <span class="nx">errc</span> <span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">eventCount</span> <span class="o">:=</span> <span class="mi">0</span>

	<span class="c1">// Stopping the watcher should be idempotent and if we return from this function there&#39;s no way
</span><span class="c1"></span>	<span class="c1">// we&#39;re coming back in with the same watch interface.
</span><span class="c1"></span>	<span class="k">defer</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>

<span class="nx">loop</span><span class="p">:</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="o">...</span>
		<span class="k">case</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">w</span><span class="p">.</span><span class="nf">ResultChan</span><span class="p">():</span>
			<span class="o">...</span>
			<span class="k">switch</span> <span class="nx">event</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Added</span><span class="p">:</span>
				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
				<span class="o">...</span>
			<span class="k">case</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Modified</span><span class="p">:</span>
				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
				<span class="o">...</span>
			<span class="k">case</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Deleted</span><span class="p">:</span>
				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
				<span class="o">...</span>
			<span class="k">case</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Bookmark</span><span class="p">:</span>
				<span class="c1">// A `Bookmark` means watch has synced here, just update the resourceVersion
</span><span class="c1"></span>			<span class="k">default</span><span class="p">:</span>
				<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s: unable to understand watch event %#v&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">event</span><span class="p">))</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="nx">resourceVersion</span> <span class="p">=</span> <span class="nx">newResourceVersion</span>
			<span class="nx">r</span><span class="p">.</span><span class="nf">setLastSyncResourceVersion</span><span class="p">(</span><span class="nx">newResourceVersion</span><span class="p">)</span>
			<span class="o">...</span>
		<span class="p">}</span>
	<span class="p">}</span>
  <span class="o">...</span>
<span class="p">}</span>

</code></pre></div><h3 id="22-deltafifo">2.2. DeltaFIFO</h3>
<p>DeltaFIFOå¯ä»¥åˆ†å¼€ç†è§£ï¼ŒFIFOæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œå®ƒæ‹¥æœ‰é˜Ÿåˆ—æ“ä½œçš„åŸºæœ¬æ–¹æ³•ï¼ˆå¦‚Addã€Updateã€Deleteã€Listã€Popã€Closeç­‰ï¼‰ï¼Œè€ŒDelteæ˜¯ä¸€ä¸ªèµ„æºå¯¹è±¡å­˜å‚¨ï¼Œç”¨äºä¿å­˜èµ„æºå¯¹è±¡çš„æ“ä½œç±»å‹ï¼ˆå¦‚Addedæ“ä½œç±»å‹ã€Updatedæ“ä½œç±»å‹ã€Deletedæ“ä½œç±»å‹ã€Syncæ“ä½œç±»å‹ç­‰ï¼‰ã€‚DeltaFIFOçš„structç»“æ„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/delta_fifo.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">DeltaFIFO</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="nx">items</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">Deltas</span>
	<span class="nx">queue</span> <span class="p">[]</span><span class="kt">string</span>
  <span class="o">...</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Delta</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Type</span>   <span class="nx">DeltaType</span>
	<span class="nx">Object</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Deltas</span> <span class="p">[]</span><span class="nx">Delta</span>
</code></pre></div><p>DeltaFIFOä¼šä¿ç•™æ‰€æœ‰å…³äºèµ„æºå¯¹è±¡(obj)çš„æ“ä½œç±»å‹ï¼Œé˜Ÿåˆ—ä¸­ä¼šå­˜åœ¨æ‹¥æœ‰<strong>ä¸åŒæ“ä½œç±»å‹</strong>çš„<strong>åŒä¸€ä¸ªèµ„æºå¯¹è±¡</strong>ï¼Œé˜Ÿåˆ—çš„æ¶ˆè´¹è€…èƒ½å¤Ÿåœ¨å¤„ç†è¯¥èµ„æºå¯¹è±¡æ—¶èƒ½å¤Ÿäº†è§£è¯¥èµ„æºå¯¹è±¡æ‰€å‘ç”Ÿçš„äº‹æƒ…ã€‚DeltaFIFOä½œä¸ºä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œæœ‰å…¶æ•°æ®çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œå…¶ä¸­ç”Ÿäº§è€…æ˜¯Reflectorè°ƒç”¨çš„Addæ–¹æ³•ï¼Œæ¶ˆè´¹è€…æ˜¯Controllerï¼ˆinformerçš„Controllerï¼‰è°ƒç”¨çš„Popæ–¹æ³•ã€‚ä¸‹é¢é’ˆå¯¹DeltaFIFOçš„æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿäº§è€…æ–¹æ³•ã€æ¶ˆè´¹è€…æ–¹æ³•ä»¥åŠResyncæœºåˆ¶è¿›è¡Œä»‹ç»ã€‚</p>
<h4 id="221-ç”Ÿäº§è€…æ–¹æ³•">2.2.1. ç”Ÿäº§è€…æ–¹æ³•</h4>
<p>DeltaFIFOé˜Ÿåˆ—ä¸­çš„èµ„æºå¯¹è±¡åœ¨Addedäº‹ä»¶ã€Updatedäº‹ä»¶ã€Deletedäº‹ä»¶ä¸­éƒ½è°ƒç”¨äº†queueActionLockedå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦æ ¹æ®æ“ä½œç±»å‹æŠŠèµ„æºå¯¹è±¡appendåˆ°é˜Ÿåˆ—ä¸­ï¼Œå…·ä½“çš„ä»£ç æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>é€šè¿‡f.KeyOfè®¡ç®—èµ„æºå¯¹è±¡çš„Key</li>
<li>å°†actionTypeå’Œèµ„æºå¯¹è±¡æ„é€ æˆDeltaï¼Œæ·»åŠ åˆ°itemsä¸­ï¼Œå¹¶é€šè¿‡dedupDeltaså‡½æ•°è¿›è¡Œå»é‡æ“ä½œ</li>
<li>æ›´æ–°æ„é€ åçš„Deltaå¹¶é€šè¿‡f.cond.Broadcasté€šçŸ¥æ‰€æœ‰æ¶ˆè´¹è€…è§£é™¤é˜»å¡</li>
</ol>
<p>queueActionLockedä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/delta_fifo.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">DeltaFIFO</span><span class="p">)</span> <span class="nf">queueActionLocked</span><span class="p">(</span><span class="nx">actionType</span> <span class="nx">DeltaType</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">KeyOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
	<span class="o">...</span>
	<span class="nx">oldDeltas</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
	<span class="nx">newDeltas</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">oldDeltas</span><span class="p">,</span> <span class="nx">Delta</span><span class="p">{</span><span class="nx">actionType</span><span class="p">,</span> <span class="nx">obj</span><span class="p">})</span>
	<span class="nx">newDeltas</span> <span class="p">=</span> <span class="nf">dedupDeltas</span><span class="p">(</span><span class="nx">newDeltas</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">newDeltas</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span> <span class="p">!</span><span class="nx">exists</span> <span class="p">{</span>
			<span class="nx">f</span><span class="p">.</span><span class="nx">queue</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">f</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">newDeltas</span>
		<span class="nx">f</span><span class="p">.</span><span class="nx">cond</span><span class="p">.</span><span class="nf">Broadcast</span><span class="p">()</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">...</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><h4 id="222-æ¶ˆè´¹è€…æ–¹æ³•">2.2.2. æ¶ˆè´¹è€…æ–¹æ³•</h4>
<p>Popæ–¹æ³•ä½œä¸ºæ¶ˆè´¹è€…æ–¹æ³•ä½¿ç”¨ï¼Œè¯¥æ–¹æ³•ä»DeltaFIFOçš„å¤´éƒ¨å»é™¤æœ€æ—©è¿›å…¥é˜Ÿåˆ—ä¸­çš„èµ„æºå¯¹è±¡æ•°æ®ã€‚åœ¨è°ƒç”¨Popæ–¹æ³•æ—¶é¡»ä¼ å…¥processå‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºæ¥æ”¶å¹¶å¤„ç†å¯¹è±¡çš„å›è°ƒæ–¹æ³•ã€‚Popæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/delta_fifo.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">DeltaFIFO</span><span class="p">)</span> <span class="nf">Pop</span><span class="p">(</span><span class="nx">process</span> <span class="nx">PopProcessFunc</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="o">...</span>
			<span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">closed</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrFIFOClosed</span>
			<span class="p">}</span>

			<span class="nx">f</span><span class="p">.</span><span class="nx">cond</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
		<span class="p">}</span>
		<span class="nx">id</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="nx">f</span><span class="p">.</span><span class="nx">queue</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">queue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
		<span class="o">...</span>
		<span class="nx">item</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
		<span class="o">...</span>
		<span class="nb">delete</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nf">process</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">ErrRequeue</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="nx">f</span><span class="p">.</span><span class="nf">addIfNotPresent</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
			<span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Err</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œé€šè¿‡f.cond.Waité˜»å¡ç­‰å¾…æ•°æ®ï¼Œåªæœ‰æ”¶åˆ°cond.Broadcastæ—¶æ‰è¯´æ˜æœ‰æ•°æ®åŠ å…¥é˜Ÿåˆ—ï¼Œæ­¤æ—¶é˜»å¡æ‰è¢«æ¸…é™¤ã€‚å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™å–å‡ºé˜Ÿåˆ—å¤´ï¼Œå°†è¯¥å¯¹è±¡ä¼ å…¥processå‡½æ•°ï¼Œç”±ä¸Šå±‚æ¶ˆè´¹è€…å¤„ç†ï¼Œè‹¥processå›è°ƒå‡½æ•°å¤„ç†å‡ºé”™ï¼Œåˆ™å°†å¯¹è±¡é‡æ–°å­˜å…¥é˜Ÿåˆ—ã€‚
Controllerçš„processLoopæ–¹æ³•è´Ÿè´£ä»DeltaFIFOé˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®ï¼Œå¹¶ä¼ ç»™å›è°ƒå‡½æ•°ã€‚è€Œprocesså›è°ƒå‡½æ•°ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/shared_informer.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span> <span class="nf">HandleDeltas</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">obj</span><span class="p">.(</span><span class="nx">Deltas</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">Sync</span><span class="p">,</span> <span class="nx">Replaced</span><span class="p">,</span> <span class="nx">Added</span><span class="p">,</span> <span class="nx">Updated</span><span class="p">:</span>
			<span class="o">...</span>
			<span class="k">if</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">exists</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">exists</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="k">return</span> <span class="nx">err</span>
				<span class="p">}</span>
        <span class="o">...</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nf">distribute</span><span class="p">(</span><span class="nx">updateNotification</span><span class="p">{</span><span class="nx">oldObj</span><span class="p">:</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">newObj</span><span class="p">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">},</span> <span class="nx">isSync</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="k">return</span> <span class="nx">err</span>
				<span class="p">}</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nf">distribute</span><span class="p">(</span><span class="nx">addNotification</span><span class="p">{</span><span class="nx">newObj</span><span class="p">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">},</span> <span class="kc">false</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="nx">Deleted</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>
			<span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nf">distribute</span><span class="p">(</span><span class="nx">deleteNotification</span><span class="p">{</span><span class="nx">oldObj</span><span class="p">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">},</span> <span class="kc">false</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>HandleDeltaså‡½æ•°ä½œä¸ºprocesså›è°ƒå‡½æ•°ï¼Œå½“èµ„æºå¯¹è±¡çš„æ“ä½œç±»å‹ä¸ºAddedã€Updatedã€Deletedæ—¶ï¼Œåœ¨indexerä¸­å¯¹è¯¥èµ„æºå¯¹è±¡è¿›è¡Œç›¸åº”æ“ä½œï¼ˆè¯¥æ“ä½œå¹¶å‘å®‰å…¨ï¼‰ï¼Œå¹¶é€šè¿‡distributeå‡½æ•°å°†èµ„æºå¯¹è±¡åˆ†å‘è‡³SharedInformerä¸­ã€‚å¦‚Addedæ“ä½œå³å¯¹åº”çš„informer.AddEventHandlerå‡½æ•°ã€‚</p>
<h4 id="223-resyncæœºåˆ¶">2.2.3. Resyncæœºåˆ¶</h4>
<p>Resyncæœºåˆ¶ä¼šå°†Indexeræœ¬åœ°å­˜å‚¨ä¸­çš„èµ„æºå¯¹è±¡åŒæ­¥åˆ°DeltaFIFOä¸­ï¼Œå¹¶å°†è¿™äº›èµ„æºå¯¹è±¡è®¾ç½®ä¸ºSyncæ“ä½œç±»å‹ã€‚Resyncå‡½æ•°åœ¨Reflectorä¸­å®šæ—¶æ‰§è¡Œï¼Œæ‰§è¡Œå‘¨æœŸåœ¨ç”ŸæˆReflectorå¯¹è±¡æ—¶ï¼Œç”±ä¼ å…¥çš„resyncPeriodå‚æ•°è®¾å®šã€‚å…·ä½“ä»£ç åœ¨ListAndWatchå‡½æ•°ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/reflector.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Reflector</span><span class="p">)</span> <span class="nf">ListAndWatch</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="nx">resyncerrc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="nx">cancelCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">cancelCh</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">resyncCh</span><span class="p">,</span> <span class="nx">cleanup</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">resyncChan</span><span class="p">()</span>
		<span class="o">...</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">resyncCh</span><span class="p">:</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">stopCh</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">cancelCh</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ShouldResync</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">r</span><span class="p">.</span><span class="nf">ShouldResync</span><span class="p">()</span> <span class="p">{</span>
				<span class="o">...</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Resync</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">resyncerrc</span> <span class="o">&lt;-</span> <span class="nx">err</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="o">...</span>
		<span class="p">}</span>
	<span class="p">}()</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></div><p>Reflector åœ¨ ListAndWatch å‡½æ•°ä¸­å¯åŠ¨äº†ä¸€ä¸ªgoroutineå®šæ—¶å®è¡Œr.store.Resyncæ“ä½œï¼Œè€Œåœ¨DeltaFIFOä¸­Resync-&gt;syncKeyLockedä»£ç å¦‚ä¸‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/delta_fifo.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">DeltaFIFO</span><span class="p">)</span> <span class="nf">syncKeyLocked</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">obj</span><span class="p">,</span> <span class="nx">exists</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">knownObjects</span><span class="p">.</span><span class="nf">GetByKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
	<span class="o">...</span>
	<span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">KeyOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
	<span class="o">...</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nf">queueActionLocked</span><span class="p">(</span><span class="nx">Sync</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;couldn&#39;t queue object: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>f.knownObjectsæ˜¯indexeræœ¬åœ°å­˜å‚¨å¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡å¯ä»¥è·å–client-goç›®å‰å­˜å‚¨çš„æ‰€æœ‰èµ„æºå¯¹è±¡ã€‚</p>
<h3 id="23-indexer">2.3. Indexer</h3>
<p>Indexeræ˜¯client-goç”¨æ¥å­˜å‚¨èµ„æºå¯¹è±¡å¹¶è‡ªå¸¦ç´¢å¼•åŠŸèƒ½çš„æœ¬åœ°å­˜å‚¨ï¼ŒReflectorä»DeltaFIFOä¸­å°†æ¶ˆè´¹å‡ºæ¥çš„èµ„æºå¯¹è±¡å­˜å‚¨è‡³Indexerã€‚Indexerä¸­çš„æ•°æ®ä¸Etcdä¸­æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œå› æ­¤client-goå¯ä»¥æ–¹ä¾¿åœ°ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–æ•°æ®ï¼Œæ— éœ€æ¯æ¬¡éƒ½ä»è¿œç«¯etcdè·å–ï¼Œå‡è½»api-serverå‹åŠ›ã€‚
Indexeræ˜¯åœ¨ThreadSafeMapï¼ˆå…·æœ‰å¹¶å‘å®‰å…¨ç‰¹æ€§ï¼‰çš„åŸºç¡€ä¸Šè¿›è¡Œäº†å°è£…ï¼Œé™¤äº†ç»§æ‰¿äº†ThreadSafeMapçš„æ“ä½œæ–¹æ³•åŒæ—¶å®ç°äº†Indexer Funcç­‰åŠŸèƒ½ï¼ˆå¦‚Indexã€IndexKyesã€GetIndexersç­‰æ–¹æ³•ï¼‰ï¼Œå­˜å‚¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<figure style="flex-grow: 112; flex-basis: 271px">
		<a href="/p/client-go-informer/indexer.png" data-size="261x231"><img src="/p/client-go-informer/indexer.png"
				srcset="/p/client-go-informer/indexer_hub7b336499dbd6136510792c433161732_10047_480x0_resize_box_2.png 480w, /p/client-go-informer/indexer_hub7b336499dbd6136510792c433161732_10047_1024x0_resize_box_2.png 1024w"
				width="261"
				height="231"
				loading="lazy"
				alt="Indexerå­˜å‚¨ç»“æ„">
		</a>
		
		<figcaption>Indexerå­˜å‚¨ç»“æ„</figcaption>
		
	</figure></p>
<h4 id="231-threadsafemapå¹¶å‘å®‰å…¨å­˜å‚¨">2.3.1. ThreadSafeMapå¹¶å‘å®‰å…¨å­˜å‚¨</h4>
<p>ThreadSafeMapæ˜¯ä¸€ä¸ªå†…å­˜ä¸­çš„å­˜å‚¨ï¼Œæ•°æ®ä¸ä¼šå†™å…¥æœ¬åœ°ç£ç›˜ä¸­ï¼Œåœ¨è¿›è¡Œå¢ã€åˆ ã€è¯¥ã€æŸ¥æ“ä½œéƒ½ä¼šè¿›è¡ŒåŠ é”ï¼Œä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚ThreadSafeMapå°†èµ„æºå¯¹è±¡å­˜å‚¨äºä¸€ä¸ªmapæ•°æ®ç»“æ„ä¸­ã€‚å…¶æ•°æ®ç»“æ„ä»£ç å¦‚ä¸‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/thread_safe_store.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">threadSafeMap</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">lock</span>  <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
	<span class="nx">items</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="c1">// indexers maps a name to an IndexFunc
</span><span class="c1"></span>	<span class="nx">indexers</span> <span class="nx">Indexers</span>
	<span class="c1">// indices maps a name to an Index
</span><span class="c1"></span>	<span class="nx">indices</span> <span class="nx">Indices</span>
<span class="p">}</span>
</code></pre></div><p>itemså­—æ®µå­˜å‚¨çš„æ˜¯èµ„æºå¯¹è±¡æ•°æ®ï¼Œå…¶ä¸­itemsçš„keyé€šè¿‡keyFuncå‡½æ•°è®¡ç®—å¾—åˆ°ã€‚</p>
<h4 id="232-indexerç´¢å¼•å™¨">2.3.2. Indexerç´¢å¼•å™¨</h4>
<p>æ¯æ¬¡å¢ã€åˆ ã€æ”¹ThreadSafeStoreæ•°æ®æ—¶ï¼Œéƒ½ä¼šé€šè¿‡updateIndecesæˆ–deleteFromIndeiceså‡½æ•°å˜æ›´Indexerã€‚Indexerè¢«è®¾è®¡ä¸ºå¯ä»¥è‡ªå®šä¹‰ç´¢å¼•å‡½æ•°ï¼Œå…¶4ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ä¸ºIndeicesã€Indexã€Indexerä»¥åŠIndexFuncï¼Œæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/index.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// IndexFunc knows how to compute the set of indexed values for an object.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">IndexFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

<span class="c1">// Index maps the indexed value to a set of keys in the store that match on that value
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Index</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">sets</span><span class="p">.</span><span class="nx">String</span>

<span class="c1">// Indexers maps a name to a IndexFunc
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Indexers</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">IndexFunc</span>

<span class="c1">// Indices maps a name to an Index
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Indices</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">Index</span>
</code></pre></div><ul>
<li><strong>Indexers:</strong> å­˜å‚¨ç´¢å¼•å™¨ï¼Œkeyä¸ºç´¢å¼•å™¨åç§°ï¼Œvalueä¸ºç´¢å¼•å™¨å®ç°å‡½æ•°ã€‚</li>
<li><strong>IndexFunc:</strong> ç´¢å¼•å™¨å‡½æ•°ï¼Œå®šä¹‰ä¸ºæ¥å—ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œè¿”å›ç´¢å¼•ç»“æœåˆ—è¡¨ã€‚</li>
<li><strong>Indices:</strong> å­˜å‚¨ç¼“å­˜å™¨ï¼Œkeyä¸ºç¼“å­˜å™¨åç§°ï¼Œvalueä¸ºç¼“å­˜æ•°æ®ã€‚</li>
<li><strong>Index:</strong> å­˜å‚¨ç¼“å­˜æ•°æ®ï¼Œæ•°æ®ç»“æ„ä¸ºK/Vç»“æ„ã€‚</li>
</ul>
<h4 id="233-indexerç´¢å¼•å™¨æ ¸å¿ƒå®ç°">2.3.3. Indexerç´¢å¼•å™¨æ ¸å¿ƒå®ç°</h4>
<p>index.ByIndexå‡½æ•°é€šè¿‡æ‰§è¡Œç´¢å¼•å™¨å‡½æ•°å¾—åˆ°ç´¢å¼•ç»“æœï¼Œä»£ç ç¤ºä¾‹ï¼š</p>
<p><strong>ä»£ç è·¯å¾„ï¼šclient-go/tools/cache/thread_safe_store.go</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">threadSafeMap</span><span class="p">)</span> <span class="nf">ByIndex</span><span class="p">(</span><span class="nx">indexName</span><span class="p">,</span> <span class="nx">indexedValue</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="nx">indexFunc</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">indexers</span><span class="p">[</span><span class="nx">indexName</span><span class="p">]</span>
	<span class="o">...</span>
	<span class="nx">index</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="nx">indexName</span><span class="p">]</span>
	<span class="nx">set</span> <span class="o">:=</span> <span class="nx">index</span><span class="p">[</span><span class="nx">indexedValue</span><span class="p">]</span>
	<span class="nx">list</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">set</span><span class="p">.</span><span class="nf">Len</span><span class="p">())</span>
	<span class="k">for</span> <span class="nx">key</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">set</span> <span class="p">{</span>
		<span class="nx">list</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">list</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>ByIndexæ¥æ”¶ä¸¤ä¸ªå‚æ•°:IndexName(ç´¢å¼•å™¨åç§°)å’ŒindexKey(éœ€è¦æ£€ç´¢çš„key)ã€‚é¦–å…ˆä»c.indexersä¸­æŸ¥æ‰¾æŒ‡å®šçš„ç´¢å¼•å™¨å‡½æ•°ï¼Œä»c.indicesä¸­æŸ¥æ‰¾æŒ‡å®šçš„ç¼“å­˜å™¨å‡½æ•°ï¼Œç„¶åæ ¹æ®ç´¢å¼•çš„indexKeyä»ç¼“å­˜æ•°æ®ä¸­æŸ¥åˆ°å¹¶è¿”å›</p>
<h2 id="3-å‚è€ƒæ–‡çŒ®">3. å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li><strong>ã€ŠKubernetesæºç å‰–æã€‹</strong> <strong>ä½œè€…</strong>ï¼šéƒ‘ä¸œæ—­</li>
<li>client-goæºç  <strong>ç‰ˆæœ¬</strong>:release-1.20 <strong>commit</strong>:fb61a7c88cb9f599363919a34b7c54a605455ffc</li>
</ol>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/k8s/">k8s</a>
        
            <a href="/tags/client-go/">client-go</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    

    <section class="article-view">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-eye" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="2" />
  <path d="M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7" />
</svg>
        <span id="/p/client-go-informer/" class="leancloud_visitors" data-flag-title="client-go Informerç®€ä»‹">
            <span class="leancloud-visitors-count">loading</span><span> VIEWS</span>
        </span>
    </section></footer>

    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="">
    <a href="/p/client-go-workqueue/">
        
        

        <div class="article-details">
            <h2 class="article-title">client-go WorkQueueå·¥ä½œé˜Ÿåˆ—ç®€ä»‹</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/p/client-go-eventbroadcaster/">
        
        

        <div class="article-details">
            <h2 class="article-title">client-go EventBroadcasteräº‹ä»¶ç®¡ç†å™¨ç®€ä»‹</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>


    
        
    <script src="https://utteranc.es/client.js" 
        repo="genfanh/genfanh-blog-comments"
        issue-term="pathname"
        theme="preferred-color-scheme" 
        
        label="production"
        
        crossorigin="anonymous" 
        async>
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${e.detail}`
                },
                'https://utteranc.es'
            );
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2021 genfanh Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="2.0.1">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css">
            </main>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"
    integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FX29Q4RR92"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-FX29Q4RR92');
</script>

<script src='//unpkg.com/valine/dist/Valine.min.js'></script>

<script type="text/javascript">
  new Valine({
      el: '#vcomments',
      appId: 'IBQOzRWMnNNe0iMr5YiXQ9oD-MdYXbMMI',
      appKey: 'Wf6ROG9SvmzvuFEANW7NmNiX',
      avatar: 'retro', 
      placeholder: 'è¯´ç‚¹ä»€ä¹ˆå§...',
      visitor: 'true',
      requiredFields: ['nick', 'mail']
  });
</script>
    </body>
</html>
